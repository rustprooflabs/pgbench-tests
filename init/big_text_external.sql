/*
    Init script for pgbench.  

    Creates table `dev_text.pgbench_ext` with 
    scale * 10,000 rows.
    
    length(md5()) = 32
    Total length of text is pseudo-random using
    32 * (base_legth + ceil(random() * 25))

    Example usage:
         psql -d bench_test \
            -v scale=100 -v base_length=55 \
            -f init/big_text_external.sql 

*/


CREATE SCHEMA IF NOT EXISTS dev_text;
DROP TABLE IF EXISTS dev_text.pgbench_ext CASCADE;

CREATE TABLE dev_text.pgbench_ext
(
    id BIGINT NOT NULL GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    val TEXT NOT NULL 
);

ALTER TABLE dev_text.pgbench_ext 
    ALTER COLUMN val SET STORAGE EXTERNAL;


INSERT INTO dev_text.pgbench_ext (val)
SELECT repeat(md5(random()::TEXT),
            :base_length + ceil(random() * 25)::INT)
    FROM generate_series(1, (:scale * 10000) ) x
;


ANALYZE dev_text.pgbench_ext;

